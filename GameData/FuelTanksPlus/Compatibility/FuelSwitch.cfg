
// All fuel switching rules are here. Paint-switching rules are in each of the 
// category folders with the parts located there, since each size-class has
// its own set of colors and mesh names.

// NOTE: The "Radial" tanks have the fuel switching configs in their own folder,
// rather than here, since it's more tightly tied to their color switching, etc.


//--------------------------------------------------------------------------------
// Turn on global radial fuel crossfeed, so that it can be switched on per-tank.

@PHYSICSGLOBALS
{
	@stack_PriUsesSurf = True
}


//--------------------------------------------------------------------------------
// Set up the tank types we use, if B9 is installed:

B9_TANK_TYPE:NEEDS[B9PartSwitch]
{
	name = FTPOxidizer
	tankMass = 0.000125
	tankCost = 0.0
	RESOURCE
	{
		name = Oxidizer
		unitsPerVolume = 1
	}
}
B9_TANK_TYPE:NEEDS[B9PartSwitch]
{
	name = FTPLiquidFuel
	tankMass = 0.000125
	tankCost = 0.0
	RESOURCE
	{
		name = LiquidFuel
		unitsPerVolume = 1
	}
}
B9_TANK_TYPE:NEEDS[B9PartSwitch]
{
	name = FTPLFO
	tankMass = 0.000125
	tankCost = 0.0
	RESOURCE
	{
		name = LiquidFuel
		unitsPerVolume = 0.45
	}
	RESOURCE
	{
		name = Oxidizer
		unitsPerVolume = 0.55
	}
}
B9_TANK_TYPE:NEEDS[B9PartSwitch]
{
	name = FTPMonoPropellant
	tankMass = 0.0004
	tankCost = 1.25
	RESOURCE
	{
		name = MonoPropellant
		unitsPerVolume = 1.175
	}
}
B9_TANK_TYPE:NEEDS[B9PartSwitch]
{
	name = FTPXenon
	tankMass = 0.0022
	tankCost = 55
	RESOURCE
	{
		name = XenonGas
		unitsPerVolume = 28
	}
}
B9_TANK_TYPE:NEEDS[B9PartSwitch]
{
	name = FTPOre
	tankMass = 0.00025
	tankCost = 3.0
	RESOURCE
	{
		name = Ore
		unitsPerVolume = 2
	}
}

//--------------------------------------------------------------------------------
// Bulk update tanks with Firespitter or InterstellarFuelSwitch:

@PART[TPtankL*|TPtank?mL*|TPdome*|TPcone*|TPtank?m?mA]:HAS[@RESOURCE[LiquidFuel],@RESOURCE[Oxidizer],!MODULE[InterstellarFuelSwitch],!MODULE[FSfuelSwitch],!MODULE[ModuleB9PartSwitch]]:NEEDS[Firespitter|InterstellarFuelSwitch&!CryoTanks&!ModularFuelTanks&!RealFuels&!B9PartSwitch]:AFTER[FuelTanksPlus]
{
	//%LF = #$RESOURCE[LiquidFuel]/maxAmount$
	//%OX = #$RESOURCE[Oxidizer]/maxAmount$

	//%LF2 = #$LF$
	//@LF2 *= 2
	//%OX2 = #$OX$
	//@OX2 *= 2
	//%Monoprop = #$mass$
	//@Monoprop *= 1880

    // --- temp values stored in a disposable node ---
    __TMP_FTP_FUEL
    {
        %LF = #$../RESOURCE[LiquidFuel]/maxAmount$
        %OX = #$../RESOURCE[Oxidizer]/maxAmount$

        %LF2 = #$LF$
        @LF2 *= 2

        %OX2 = #$OX$
        @OX2 *= 2

        %Monoprop = #$../mass$
        @Monoprop *= 1880
    }	

	MODULE
	{
		name:NEEDS[!InterstellarFuelSwitch] = FSfuelSwitch
		name:NEEDS[InterstellarFuelSwitch] = InterstellarFuelSwitch
		volumeMultiplier:NEEDS[InterstellarFuelSwitch] = 1
		massMultiplier:NEEDS[InterstellarFuelSwitch] = 1
		tankSwitchNames:NEEDS[InterstellarFuelSwitch] = LF+OX;LiquidFuel;Oxidizer;MonoProp
		resourceGui:NEEDS[InterstellarFuelSwitch] = LiquidFuel+Oxidizer;LiquidFuel;Oxidizer;MonoPropellant
		resourceNames = LiquidFuel,Oxidizer;LiquidFuel;Oxidizer;MonoPropellant
	    resourceAmounts = #$../__TMP_FTP_FUEL/LF$,$../__TMP_FTP_FUEL/OX$;$../__TMP_FTP_FUEL/LF2$;$../__TMP_FTP_FUEL/OX2$;$../__TMP_FTP_FUEL/Monoprop$
        basePartMass = #$../mass$
		tankTechReq:NEEDS[InterstellarFuelSwitch] = start;start;start;advFuelSystems
	}
	!RESOURCE[LiquidFuel] {}
	!RESOURCE[Oxidizer] {}

    // --- delete the temp node so nothing “lingers” in the final part ---
    !__TMP_FTP_FUEL {}
}

@PART[TPtank?mL?????-Nuke]:HAS[@RESOURCE[LiquidFuel],!RESOURCE[Oxidizer],!MODULE[InterstellarFuelSwitch],!MODULE[FSfuelSwitch],!MODULE[ModuleB9PartSwitch]]:NEEDS[Firespitter|InterstellarFuelSwitch&!CryoEngines&!ModularFuelTanks&!RealFuels&!B9PartSwitch]:AFTER[FuelTanksPlus]
{
	//%LF = #$RESOURCE[LiquidFuel]/maxAmount$
	//%OX = #$LF$
	////@OX *= 11
	////@OX /= 9

	//%XenonMass = #$mass$
	//@XenonMass *= 3.3
	//%OreMass = #$mass$
	//@OreMass *= 2
	
	//%Xenon = #$XenonMass$
	//@Xenon *= 14000
	//%Monoprop = #$mass$
	//@Monoprop *= 1880
	//%Ore = #$OreMass$
	//@Ore *= 750

    // --- temp values stored in a disposable node ---
    __TMP_FTP_NUKE
    {
        %LF = #$../RESOURCE[LiquidFuel]/maxAmount$

        %OX = #$LF$

        %XenonMass = #$../mass$
        @XenonMass *= 3.3

        %OreMass = #$../mass$
        @OreMass *= 2

        %Xenon = #$XenonMass$
        @Xenon *= 14000

        %Monoprop = #$../mass$
        @Monoprop *= 1880

        %Ore = #$OreMass$
        @Ore *= 750
    }


	@mass = 0
	MODULE
	{
		name:NEEDS[!InterstellarFuelSwitch] = FSfuelSwitch
		name:NEEDS[InterstellarFuelSwitch] = InterstellarFuelSwitch
		volumeMultiplier:NEEDS[InterstellarFuelSwitch] = 1
		massMultiplier:NEEDS[InterstellarFuelSwitch] = 1
		tankSwitchNames:NEEDS[InterstellarFuelSwitch] = LiquidFuel;Oxidizer;Xenon;MonoProp;Ore
		resourceGui:NEEDS[InterstellarFuelSwitch] = LiquidFuel;Oxidizer;Xenon;MonoPropellant;Ore
		resourceNames = LiquidFuel;Oxidizer;XenonGas;MonoPropellant;Ore
		resourceAmounts = #$../__TMP_FTP_NUKE/LF$;$../__TMP_FTP_NUKE/OX$;$../__TMP_FTP_NUKE/Xenon$;$../__TMP_FTP_NUKE/Monoprop$;$../__TMP_FTP_NUKE/Ore$
		basePartMass = 0
		tankMass = #$../mass$;$../mass$;$../__TMP_FTP_NUKE/XenonMass$;$../mass$;$../__TMP_FTP_NUKE/OreMass$
		tankTechReq:NEEDS[InterstellarFuelSwitch] = start;start;ionPropulsion;advFuelSystems;advScienceTech
	}
	!RESOURCE[LiquidFuel] {}

    // --- delete the temp node so nothing “lingers” in the final part ---
    !__TMP_FTP_NUKE {}
}


@PART[TPtankTri]:HAS[@RESOURCE[LiquidFuel],@RESOURCE[Oxidizer],!MODULE[InterstellarFuelSwitch],!MODULE[FSfuelSwitch],!MODULE[ModuleB9PartSwitch]]:NEEDS[Firespitter|InterstellarFuelSwitch&!CryoEngines&!ModularFuelTanks&!RealFuels&!B9PartSwitch]:AFTER[FuelTanksPlus]
{
	MODULE
	{
		name:NEEDS[!InterstellarFuelSwitch] = FSfuelSwitch
		name:NEEDS[InterstellarFuelSwitch] = InterstellarFuelSwitch
		volumeMultiplier:NEEDS[InterstellarFuelSwitch] = 1
		massMultiplier:NEEDS[InterstellarFuelSwitch] = 1
		tankSwitchNames:NEEDS[InterstellarFuelSwitch] = LF+OX;Xenon;MonoProp
		resourceGui:NEEDS[InterstellarFuelSwitch] = LiquidFuel+Oxidizer;Xenon;MonoPropellant
		resourceNames = LiquidFuel,Oxidizer;XenonGas;MonoPropellant
		resourceAmounts = 22.5,27.5;2800;235
		basePartMass = #$../mass$
		tankMass = 0.0;0.09;0.0
		tankTechReq:NEEDS[InterstellarFuelSwitch] = start;ionPropulsion;advFuelSystems
	}
	!RESOURCE[LiquidFuel] {}
	!RESOURCE[Oxidizer] {}
}

@PART[TPtankCube*]:HAS[@RESOURCE[LiquidFuel],@RESOURCE[Oxidizer],!MODULE[InterstellarFuelSwitch],!MODULE[FSfuelSwitch],!MODULE[ModuleB9PartSwitch]]:NEEDS[Firespitter|InterstellarFuelSwitch&!CryoEngines&!ModularFuelTanks&!RealFuels&!B9PartSwitch]:AFTER[FuelTanksPlus]
{
	//%LF = #$RESOURCE[LiquidFuel]/maxAmount$
	//%OX = #$RESOURCE[Oxidizer]/maxAmount$

	//%Xenon = #$mass$
	//@Xenon *= 14000
	//%Monoprop = #$mass$
	//@Monoprop *= 1880

    // --- temp values stored in a disposable node ---
    __TMP_FTP_CUBE
    {
        %LF = #$../RESOURCE[LiquidFuel]/maxAmount$
        %OX = #$../RESOURCE[Oxidizer]/maxAmount$

        %Xenon = #$../mass$
        @Xenon *= 14000

        %Monoprop = #$../mass$
        @Monoprop *= 1880
    }

	MODULE
	{
		name:NEEDS[!InterstellarFuelSwitch] = FSfuelSwitch
		name:NEEDS[InterstellarFuelSwitch] = InterstellarFuelSwitch
		volumeMultiplier:NEEDS[InterstellarFuelSwitch] = 1
		massMultiplier:NEEDS[InterstellarFuelSwitch] = 1
		tankSwitchNames:NEEDS[InterstellarFuelSwitch] = LF+OX;Xenon;MonoProp
		resourceGui:NEEDS[InterstellarFuelSwitch] = LiquidFuel+Oxidizer;Xenon;MonoPropellant
		resourceNames = LiquidFuel,Oxidizer;XenonGas;MonoPropellant
		resourceAmounts = #$../__TMP_FTP_CUBE/LF$,$../__TMP_FTP_CUBE/OX$;$../__TMP_FTP_CUBE/Xenon$;$../__TMP_FTP_CUBE/Monoprop$
		basePartMass = #$../mass$
		tankTechReq:NEEDS[InterstellarFuelSwitch] = start;ionPropulsion;advFuelSystems
	}
	!RESOURCE[LiquidFuel] {}
	!RESOURCE[Oxidizer] {}

    // --- delete the temp node so nothing “lingers” in the final part ---
    !__TMP_FTP_CUBE {}
}




//--------------------------------------------------------------------------------
// Bulk update tanks with B9PartSwitch:


@PART[TPtankL*|TPtank?mL*|TPdome*|TPcone*|TPtank?m?mA]:HAS[@RESOURCE[LiquidFuel],@RESOURCE[Oxidizer],!MODULE[InterstellarFuelSwitch],!MODULE[FSfuelSwitch],!MODULE[ModuleB9PartSwitch]]:NEEDS[B9PartSwitch&!CryoTanks&!ModularFuelTanks&!RealFuels]:AFTER[FuelTanksPlus]
{
	//%totalCap = #$RESOURCE[LiquidFuel]/maxAmount$
	//@totalCap += #$RESOURCE[Oxidizer]/maxAmount$

	//%massOffset = #$mass$
	//@massOffset *= -1

    // --- temp values stored in a disposable node ---
    __TMP_FTP_B9PS
    {
        %totalCap = #$../RESOURCE[LiquidFuel]/maxAmount$
        @totalCap += #$../RESOURCE[Oxidizer]/maxAmount$

        %massOffset = #$../mass$
        @massOffset *= -1
    }	

	MODULE
	{
		name = ModuleB9PartSwitch
		moduleID = fuelSwitch
		switcherDescription = Tank Type
		baseVolume = #$../__TMP_FTP_B9PS/totalCap$

		SUBTYPE
		{
			name = LF/O
			tankType = FTPLFO
			addedMass = #$../../__TMP_FTP_B9PS/massOffset$
		}
		SUBTYPE
		{
			name = LiquidFuel
			tankType = FTPLiquidFuel
			addedMass = #$../../__TMP_FTP_B9PS/massOffset$
		}
		SUBTYPE
		{
			name = Oxidizer
			tankType = FTPOxidizer
			addedMass = #$../../__TMP_FTP_B9PS/massOffset$
		}
		SUBTYPE
		{
			name = MonoPropellant
			tankType = FTPMonoPropellant
			addedMass = #$../../__TMP_FTP_B9PS/massOffset$
		}
	}
	!RESOURCE[LiquidFuel] {}
	!RESOURCE[Oxidizer] {}

    // --- delete the temp node so nothing “lingers” in the final part ---
    !__TMP_FTP_B9PS {}	
}

@PART[TPtank?mL?????-Nuke]:HAS[@RESOURCE[LiquidFuel],!RESOURCE[Oxidizer],!MODULE[InterstellarFuelSwitch],!MODULE[FSfuelSwitch],!MODULE[ModuleB9PartSwitch]]:NEEDS[B9PartSwitch&!CryoEngines&!ModularFuelTanks&!RealFuels]:AFTER[FuelTanksPlus]
{
	//%totalCap = #$RESOURCE[LiquidFuel]/maxAmount$

	//%massOffset = #$mass$
	//@massOffset *= -1

    // --- temp values stored in a disposable node ---
    __TMP_FTP_B9PS
    {
        %totalCap = #$../RESOURCE[LiquidFuel]/maxAmount$

        %massOffset = #$../mass$
        @massOffset *= -1
    }

	MODULE
	{
		name = ModuleB9PartSwitch
		moduleID = fuelSwitch
		switcherDescription = Tank Type
		baseVolume = #$../__TMP_FTP_B9PS/totalCap$

		SUBTYPE
		{
			name = LiquidFuel
			tankType = FTPLiquidFuel
			addedMass = #$../../__TMP_FTP_B9PS/massOffset$
		}
		SUBTYPE
		{
			name = Oxidizer
			tankType = FTPOxidizer
			addedMass = #$../../__TMP_FTP_B9PS/massOffset$
		}
		SUBTYPE
		{
			name = XenonGas
			tankType = FTPXenon
			addedMass = #$../../__TMP_FTP_B9PS/massOffset$
		}
		SUBTYPE
		{
			name = MonoPropellant
			tankType = FTPMonoPropellant
			addedMass = #$../../__TMP_FTP_B9PS/massOffset$
		}
		SUBTYPE
		{
			name = Ore
			tankType = FTPOre
			addedMass = #$../../__TMP_FTP_B9PS/massOffset$
		}
	}
	!RESOURCE[LiquidFuel] {}
    // --- delete the temp node so nothing “lingers” in the final part ---
    !__TMP_FTP_B9PS {}	
}


@PART[TPtankTri|TPtankCube*]:HAS[@RESOURCE[LiquidFuel],@RESOURCE[Oxidizer],!MODULE[InterstellarFuelSwitch],!MODULE[FSfuelSwitch],!MODULE[ModuleB9PartSwitch]]:NEEDS[B9PartSwitch&!CryoEngines&!ModularFuelTanks&!RealFuels]:AFTER[FuelTanksPlus]
{
	//%totalCap = #$RESOURCE[LiquidFuel]/maxAmount$
	//@totalCap += #$RESOURCE[Oxidizer]/maxAmount$

	//%massOffset = #$mass$
	//@massOffset *= -1

	// --- temp values stored in a disposable node ---
    __TMP_FTP_B9PS
    {
        %totalCap = #$../RESOURCE[LiquidFuel]/maxAmount$
        @totalCap += #$../RESOURCE[Oxidizer]/maxAmount$

        %massOffset = #$../mass$
        @massOffset *= -1
    }

	MODULE
	{
		name = ModuleB9PartSwitch
		moduleID = fuelSwitch
		switcherDescription = Tank Type
		baseVolume = #$../__TMP_FTP_B9PS/totalCap$

		SUBTYPE
		{
			name = LF/O
			tankType = FTPLFO
			addedMass = #$../../__TMP_FTP_B9PS/massOffset$
		}
		SUBTYPE
		{
			name = XenonGas
			tankType = FTPXenon
			addedMass = #$../../__TMP_FTP_B9PS/massOffset$
		}
		SUBTYPE
		{
			name = MonoPropellant
			tankType = FTPMonoPropellant
			addedMass = #$../../__TMP_FTP_B9PS/massOffset$
		}
	}
	!RESOURCE[LiquidFuel] {}
	!RESOURCE[Oxidizer] {}

	// --- delete the temp node so nothing “lingers” in the final part ---
    !__TMP_FTP_B9PS {}
}



//--------------------------------------------------------------------------------
// Delete temporary variables:


//@PART[TPtank*|TPdome*|TPcone*]:LAST
//{
//	!LF = 0
//	!OX = 0
//	!LF2 = 0
//	!OX2 = 0
//	!totalCap = 0
//	!massOffset = 0
//	!Xenon = 0
//	!Monoprop = 0
//	!XenonMass = 0
//	!Ore = 0
//	!OreMass = 0
//	!massOffset = 0
//}



//--------------------------------------------------------------------------------
